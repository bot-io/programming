# Apache Server Configuration for Dual Reader 3.1 PWA
# This file ensures proper MIME types, caching, and PWA functionality

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Handle Angular/Flutter routing - redirect all requests to index.html
  # This ensures deep links work correctly
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>

# MIME Types for PWA files
<IfModule mod_mime.c>
  # Manifest file
  AddType application/manifest+json .webmanifest
  AddType application/manifest+json .json
  
  # Service Worker
  AddType application/javascript .js
  
  # Icons and Images
  AddType image/png .png
  AddType image/jpeg .jpg .jpeg
  AddType image/svg+xml .svg
  AddType image/x-icon .ico
  
  # Fonts
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType font/ttf .ttf
  AddType font/otf .otf
  AddType application/font-woff .woff
  AddType application/font-woff2 .woff2
</IfModule>

# Caching Strategy
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Cache manifest and service worker for short period (1 hour)
  # This allows updates to propagate quickly
  ExpiresByType application/manifest+json "access plus 1 hour"
  ExpiresByType application/javascript "access plus 1 hour"
  
  # Cache static assets for longer (1 year)
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  
  # Cache HTML for short period (5 minutes)
  ExpiresByType text/html "access plus 5 minutes"
  
  # Cache CSS for 1 week
  ExpiresByType text/css "access plus 1 week"
</IfModule>

# Security Headers
<IfModule mod_headers.c>
  # Prevent MIME type sniffing
  Header set X-Content-Type-Options "nosniff"
  
  # Enable XSS protection
  Header set X-XSS-Protection "1; mode=block"
  
  # Prevent clickjacking
  Header set X-Frame-Options "SAMEORIGIN"
  
  # Referrer Policy
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Permissions Policy (formerly Feature Policy)
  Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  
  # Service Worker and Manifest should not be cached by browser
  <FilesMatch "\.(manifest|webmanifest|service-worker\.js|flutter_service_worker\.js)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
  
  # Allow service worker to be served from root
  <FilesMatch "service-worker\.js$|flutter_service_worker\.js$">
    Header set Service-Worker-Allowed "/"
  </FilesMatch>
</IfModule>

# Compression
<IfModule mod_deflate.c>
  # Compress HTML, CSS, JavaScript, Text, XML and fonts
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
  AddOutputFilterByType DEFLATE application/x-font
  AddOutputFilterByType DEFLATE application/x-font-opentype
  AddOutputFilterByType DEFLATE application/x-font-otf
  AddOutputFilterByType DEFLATE application/x-font-truetype
  AddOutputFilterByType DEFLATE application/x-font-ttf
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE font/opentype
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE image/x-icon
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
</IfModule>

# HTTPS Redirect (uncomment if you have SSL certificate)
# <IfModule mod_rewrite.c>
#   RewriteEngine On
#   RewriteCond %{HTTPS} off
#   RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# Error Pages (optional)
# ErrorDocument 404 /index.html
# ErrorDocument 500 /index.html
