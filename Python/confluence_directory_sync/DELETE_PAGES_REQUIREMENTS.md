# Functional Requirements: Delete Confluence Pages Utility

## 1. Overview

This document describes the functional requirements for `delete_pages.py`, a standalone Python utility that deletes Confluence pages based on a JSON file containing a list of page IDs. This utility is designed to work with JSON files generated by `confluence_sync.py` after each sync run.

## 2. Purpose

The program should:
- Read a JSON file containing a list of Confluence page IDs to delete
- Authenticate with Confluence using provided credentials
- Display all pages that will be deleted before proceeding
- Require explicit user confirmation before deletion
- Delete pages from Confluence in a controlled and safe manner
- Provide detailed logging and progress feedback
- Support dry-run mode for previewing deletions without executing them

## 3. Input Parameters

The program must accept the following command-line arguments:
- `json_file` (positional): Path to JSON file containing created pages list (e.g., `created_pages_20231215_143022.json`)
- `--url` (required): Confluence instance URL (e.g., `https://your-domain.atlassian.net`)
- `--username` (required): Confluence username or email
- `--api-token` (required): Confluence API token (for authentication)
- `--dry-run` (optional): Preview deletions without actually deleting pages

## 4. JSON File Format

The program expects JSON files in the following format (generated by `confluence_sync.py`):

```json
{
  "timestamp": "2023-12-15T14:30:22.123456",
  "root_page_id": "123456789",
  "root_page_title": "Root Page Title",
  "directory_path": "/path/to/synced/directory",
  "created_pages": [
    {
      "page_id": "987654321",
      "title": "Page Title",
      "space": "SPACE",
      "version": 1
    }
  ]
}
```

### 4.1 Required Fields

- `created_pages`: Array of page objects to delete (required)
- Each page object must contain:
  - `page_id`: Confluence page ID (required for deletion)
  - `title`: Page title (optional, used for display)
  - `space`: Confluence space key (optional, used for display)
  - `version`: Page version (optional, used for display)

### 4.2 Optional Fields

- `timestamp`: When the sync was performed (for informational display)
- `root_page_id`: ID of the root page (for informational display)
- `root_page_title`: Title of the root page (for informational display)
- `directory_path`: Path to synced directory (for informational display)

## 5. Core Functionality

### 5.1 File Loading

- Load the JSON file from the specified path
- Validate JSON structure and required fields
- Handle file not found errors gracefully
- Handle invalid JSON format errors gracefully
- Display clear error messages if file loading fails

### 5.2 Authentication

- Accept Confluence credentials via command-line arguments
- Use the `atlassian-python-api` library to authenticate with Confluence
- Test the connection by attempting to retrieve the root page (from JSON file) or any page
- Handle authentication errors gracefully with clear error messages
- Verify that the API token has sufficient permissions to delete pages

### 5.3 Page Display

- Display file information from the JSON file:
  - File path
  - Timestamp (if available)
  - Root page information (if available)
  - Directory path (if available)
  - Number of pages to delete
- Display a numbered list of all pages that will be deleted:
  - Page number (1, 2, 3, ...)
  - Page title
  - Page ID
  - Space key
- Format the output clearly and readably

### 5.4 User Confirmation

- **Always require explicit confirmation** before deleting pages (unless in dry-run mode)
- Prompt: "Are you sure you want to proceed? (yes/no):"
- Accept "yes" or "y" (case-insensitive) to proceed
- Accept any other input to cancel
- Handle EOF/KeyboardInterrupt gracefully (non-interactive environments)
- Display cancellation message if user declines

### 5.5 Dry-Run Mode

- When `--dry-run` is specified:
  - Display all pages that would be deleted
  - Skip user confirmation prompt
  - Skip actual deletion operations
  - Log what would be deleted with "[DRY RUN]" prefix
  - Provide summary of what would be deleted
  - Exit successfully without making any changes

### 5.6 Page Deletion

- For each page in the list:
  - Attempt to retrieve current page information (for verification)
  - If page retrieval fails, log a warning but continue with deletion using information from JSON
  - Delete the page using Confluence API (`remove_page` method)
  - Log success or failure for each page
  - Continue with remaining pages even if one fails
  - Track successful and failed deletions separately

### 5.7 Progress Feedback

- Display progress for each page being deleted:
  - Page number (e.g., "Deleting page 1/5")
  - Page title and ID
  - Success or failure status
- Provide a summary at the end:
  - Total number of pages processed
  - Number successfully deleted
  - Number failed (if any)
  - Exit with error code if any deletions failed

## 6. Error Handling

### 6.1 File Errors

- **File Not Found**: Display clear error message with file path and current directory
- **Invalid JSON**: Display error message with JSON parsing details
- **Missing Required Fields**: Display error message indicating which fields are missing
- **Empty Pages List**: Display message and exit successfully (nothing to delete)

### 6.2 Authentication Errors

- **Invalid URL**: Display error message and exit
- **Invalid Credentials**: Display error message and exit
- **Connection Failure**: Display error message with connection details
- **API Permission Errors**: Display error message indicating insufficient permissions

### 6.3 Deletion Errors

- **Page Not Found**: Log warning and continue with next page
- **Permission Denied**: Log error and continue with next page
- **Network Errors**: Log error and continue with next page
- **Other API Errors**: Log error with details and continue with next page
- **Track failures**: Count failed deletions and report in summary

### 6.4 Non-Interactive Environment

- Handle `EOFError` and `KeyboardInterrupt` gracefully when prompts cannot be answered
- Display appropriate cancellation messages
- Exit with appropriate error codes

## 7. Logging

### 7.1 Log Configuration

- Log to both console and file (`delete_pages.log`)
- Use UTF-8 encoding for log file
- Log format: `%(asctime)s - %(levelname)s - %(message)s`
- Log level: INFO (default)

### 7.2 Logged Information

- Script start with arguments
- File loading status
- Authentication status
- Each page deletion attempt (with success/failure)
- Summary of operations
- Errors and warnings
- Unhandled exceptions (with full traceback)

### 7.3 Log File Location

- Log file: `delete_pages.log` in the current working directory
- Log file uses append mode (multiple runs append to same file)
- If file logging fails, continue with console logging only

## 8. User Interface

### 8.1 Console Output

- Display clear section headers with separators
- Use ASCII-safe characters (no Unicode emojis) for Windows compatibility
- Format output for readability:
  - Use consistent spacing
  - Number pages clearly
  - Show status indicators: `[OK]`, `[FAIL]`, `[WARNING]`, `[DRY RUN]`

### 8.2 Progress Display

- Show current operation (e.g., "Deleting page 1/5")
- Show page details (title, ID, space)
- Show success/failure status immediately after each operation
- Display summary at the end

### 8.3 Confirmation Prompts

- Clear, unambiguous prompts
- Show what will happen (number of pages to delete)
- Require explicit confirmation
- Handle cancellation gracefully

## 9. Batch File Support (Windows)

### 9.1 Batch File Configuration

- `delete_pages.bat` provides Windows batch file support
- Stores Confluence credentials in batch file variables:
  - `CONFLUENCE_URL`: Confluence instance URL
  - `EMAIL`: Username or email
  - `CONFLUENCE_API_TOKEN`: API token (can use environment variable)
- Stores default JSON file path in `JSON_FILE` variable
- Supports command-line arguments to override default JSON file

### 9.2 Environment Variable Support

- Check for `CONFLUENCE_API_TOKEN` environment variable first
- Fall back to hardcoded value in batch file if environment variable not set
- Display clear error if API token is not set

### 9.3 Batch File Features

- Check for Python installation
- Validate JSON file exists
- Validate Python script exists
- Pass all arguments to Python script
- Display execution status
- Pause at end to show results
- Exit with appropriate error codes

## 10. Security Considerations

- Never log or expose API tokens in output
- Handle sensitive information appropriately
- Validate input parameters before processing
- Require explicit confirmation before destructive operations
- Support dry-run mode for safe testing

## 11. Dependencies

- **Required**: `atlassian-python-api` library for Confluence API interactions
- **Standard Libraries**: `json`, `sys`, `logging`, `pathlib`, `datetime`, `argparse`
- Handle missing dependencies gracefully with clear error messages

## 12. Exit Codes

- `0`: Success (all pages deleted successfully, or dry-run completed)
- `1`: Error (file loading failed, authentication failed, or one or more deletions failed)
- Exit code reflects the overall operation status

## 13. Usage Examples

### 13.1 Command Line

```bash
# Delete pages from a JSON file
python delete_pages.py created_pages_20231215_143022.json \
  --url https://your-domain.atlassian.net \
  --username user@example.com \
  --api-token YOUR_API_TOKEN

# Dry-run mode (preview only)
python delete_pages.py created_pages_20231215_143022.json \
  --url https://your-domain.atlassian.net \
  --username user@example.com \
  --api-token YOUR_API_TOKEN \
  --dry-run
```

### 13.2 Batch File (Windows)

```batch
# Edit delete_pages.bat to set:
# - JSON_FILE variable
# - CONFLUENCE_URL variable
# - EMAIL variable
# - CONFLUENCE_API_TOKEN variable (or set environment variable)

# Then run:
delete_pages.bat

# Or with custom JSON file:
delete_pages.bat created_pages_20231215_143022.json

# Or with dry-run:
delete_pages.bat --dry-run
```

## 14. Integration with confluence_sync.py

- `delete_pages.py` is designed to work with JSON files generated by `confluence_sync.py`
- After each successful sync, `confluence_sync.py` creates a JSON file listing all newly created pages
- These JSON files can be used with `delete_pages.py` to:
  - Delete all pages created in a specific sync run
  - Rollback a sync operation
  - Clean up test pages
  - Remove pages that were created by mistake

## 15. Limitations

- Can only delete pages that are listed in the JSON file
- Does not delete child pages automatically (only pages explicitly listed)
- Requires valid Confluence credentials with delete permissions
- Page deletion is permanent and cannot be undone (unless Confluence has version history/trash)
- If a page is already deleted, the program will log an error but continue with remaining pages

